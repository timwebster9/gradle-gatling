import com.timw.Gatling

node('mac') {

    stage('cleanup') {
        deleteDir()
    }

    stage('Checkout') {
        checkout scm

        scm.each { k,v ->
            echo 'key: $k, value: $v'
        }
    }

    stage('Gatling Test') {

        env.BASE_URL='http://host.docker.internal:8080'

        // run gatling
        new Gatling(this).execute()

        // gatling plugin
        gatlingArchive()

        // upload reports to Azure Blob storage
        //azureBlobUpload('buildlog-storage-account', Gatling.GATLING_REPORTS_DIR, "performance/${product}-${component}/${environment}")

        // publish metrics to CosmosDB
        env.COSMOSDB_URL       = 'https://performancedb.documents.azure.com/'
        def reportsPath = "${Gatling.GATLING_REPORTS_PATH}"

        publishToCosmosDb(this,
                          [environment: 'dev', product: 'some-webapp', component: 'backend'],
                          "${WORKSPACE}/" + reportsPath,
                          '**/*.json')
    }



}